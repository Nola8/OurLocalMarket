<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <title>Our Local Market - Shop Products</title>
    <link rel="stylesheet" href="./css/style.css" />
    <link rel="stylesheet" href="./css/farmer-style.css" />
    <link
      rel="stylesheet"
      href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css"
    />
    <style>
      .products-grid {
        display: grid;
        grid-template-columns: repeat(auto-fill, minmax(250px, 1fr));
        gap: 15px;
        padding: 10px 0;
      }

      .product-card {
        background: white;
        border-radius: 10px;
        overflow: hidden;
        box-shadow: 0 2px 8px rgba(0, 0, 0, 0.08);
        transition: all 0.3s ease;
        cursor: pointer;
        display: flex;
        flex-direction: column;
        position: relative;
        border: 1px solid #eaeaea;
      }

      .product-card:hover {
        transform: translateY(-2px);
        box-shadow: 0 4px 12px rgba(0, 0, 0, 0.12);
      }

      .product-image-container {
        position: relative;
        width: 100%;
        height: 140px;
        overflow: hidden;
        background: #f8f9fa;
      }

      .product-image {
        height: 100%;
        width: 100%;
        object-fit: cover;
      }

      .category-badge {
        position: absolute;
        top: 8px;
        left: 8px;
        background: #2f8f44;
        color: white;
        padding: 3px 8px;
        border-radius: 4px;
        font-size: 0.7rem;
        font-weight: 600;
        text-transform: uppercase;
        letter-spacing: 0.5px;
      }

      .product-info {
        padding: 12px;
        flex: 1;
        display: flex;
        flex-direction: column;
      }

      .product-name {
        font-size: 1.05rem;
        font-weight: 600;
        margin-bottom: 4px;
        color: #222;
        line-height: 1.3;
      }

      .product-price {
        font-size: 1.3rem;
        font-weight: 700;
        color: #2f8f44;
        margin: 6px 0;
      }

      .product-unit {
        color: #666;
        font-size: 0.85rem;
        font-weight: normal;
        margin-left: 2px;
      }

      .product-farmer-info {
        display: flex;
        align-items: center;
        gap: 8px;
        margin: 8px 0;
      }

      .farmer-icon {
        width: 24px;
        height: 24px;
        border-radius: 50%;
        background: #2f8f44;
        display: flex;
        align-items: center;
        justify-content: center;
        color: white;
        font-size: 0.75rem;
        flex-shrink: 0;
      }

      .farmer-name {
        font-weight: 500;
        color: #444;
        font-size: 0.85rem;
        overflow: hidden;
        text-overflow: ellipsis;
        white-space: nowrap;
        flex: 1;
      }

      .product-location {
        display: flex;
        align-items: center;
        gap: 5px;
        margin: 4px 0 8px 0;
        font-size: 0.8rem;
        color: #666;
      }

      .product-location i {
        color: #2f8f44;
        font-size: 0.75rem;
      }

      .quantity-selector {
        display: flex;
        align-items: center;
        gap: 8px;
        margin: 8px 0;
      }

      .quantity-btn {
        width: 26px;
        height: 26px;
        border: 1px solid #ddd;
        background: white;
        border-radius: 4px;
        cursor: pointer;
        display: flex;
        align-items: center;
        justify-content: center;
        font-size: 0.9rem;
        color: #333;
        transition: all 0.2s;
      }

      .quantity-btn:hover {
        background: #f5f5f5;
        border-color: #2f8f44;
      }

      .quantity-input {
        width: 45px;
        text-align: center;
        padding: 5px;
        border: 1px solid #ddd;
        border-radius: 4px;
        font-size: 0.85rem;
      }

      .product-actions {
        margin-top: auto;
        padding-top: 10px;
        border-top: 1px solid #eee;
      }

      .btn-add-to-cart {
        width: 100%;
        background: #2f8f44;
        color: white;
        border: none;
        padding: 8px 12px;
        border-radius: 6px;
        cursor: pointer;
        font-weight: 600;
        display: flex;
        align-items: center;
        justify-content: center;
        gap: 6px;
        transition: all 0.3s;
        font-size: 0.85rem;
      }

      .btn-add-to-cart:hover:not(:disabled) {
        background: #267a38;
        transform: translateY(-1px);
      }

      .btn-add-to-cart:disabled {
        background: #ccc;
        cursor: not-allowed;
        opacity: 0.6;
      }

      .btn-added {
        background: #4caf50 !important;
      }

      .products-header {
        display: flex;
        flex-direction: column;
        gap: 15px;
        margin-bottom: 20px;
        padding: 0;
        background: transparent;
        border-radius: 0;
        box-shadow: none;
      }

      .products-header h1 {
        font-size: 1.5rem;
        color: #333;
        margin: 0;
      }

      .top-bar {
        display: flex;
        justify-content: space-between;
        align-items: center;
        padding: 15px 20px;
        background: white;
        border-bottom: 1px solid #eee;
        gap: 20px;
      }

      .search-box-large {
        flex: 1;
        max-width: 500px;
        position: relative;
      }

      .search-box-large i {
        position: absolute;
        left: 15px;
        top: 50%;
        transform: translateY(-50%);
        color: #666;
        z-index: 2;
      }

      .search-box-large input {
        width: 100%;
        padding: 10px 15px 10px 45px;
        font-size: 0.95rem;
        border-radius: 8px;
        border: 1px solid #ddd;
        background: #9ed68d;
        transition: all 0.3s;
      }

      .search-box-large input:focus {
        outline: none;
        border-color: #2f8f44;
        background: rgb(120, 207, 102);
        box-shadow: 0 0 0 3px rgba(47, 143, 68, 0.1);
      }

      .top-actions {
        display: flex;
        align-items: center;
        gap: 20px;
      }

      .filter-row {
        display: flex;
        justify-content: space-between;
        align-items: center;
        background: white;
        padding: 12px 15px;
        border-radius: 8px;
        box-shadow: 0 2px 6px rgba(0, 0, 0, 0.04);
        margin-bottom: 20px;
      }

      .filter-row-left {
        display: flex;
        align-items: center;
        gap: 15px;
      }

      .filter-row-right {
        display: flex;
        align-items: center;
        gap: 10px;
      }

      #productCount {
        font-weight: 600;
        color: #2f8f44;
      }

      .cart-badge {
        position: relative;
        cursor: pointer;
        padding: 8px;
        border-radius: 50%;
        transition: background-color 0.3s;
      }

      .cart-badge:hover {
        background-color: #f5f5f5;
      }

      .cart-count {
        position: absolute;
        top: -2px;
        right: -2px;
        background: #f44336;
        color: white;
        border-radius: 50%;
        width: 20px;
        height: 20px;
        display: flex;
        align-items: center;
        justify-content: center;
        font-size: 0.75rem;
        font-weight: 600;
      }

      .user-menu img {
        width: 40px;
        height: 40px;
        border-radius: 50%;
        cursor: pointer;
        border: 2px solid #2f8f44;
      }

      .filters-container {
        display: flex;
        gap: 20px;
        margin-top: 10px;
        align-items: flex-start;
      }

      .filters-sidebar {
        width: 220px;
        background: white;
        border-radius: 10px;
        padding: 18px;
        box-shadow: 0 2px 8px rgba(0, 0, 0, 0.04);
        height: fit-content;
        position: sticky;
        top: 20px;
        flex-shrink: 0;
      }

      .products-main {
        flex: 1;
        min-width: 0;
      }

      .filter-group {
        margin-bottom: 20px;
      }

      .filter-title {
        font-weight: 600;
        margin-bottom: 12px;
        color: #333;
        font-size: 1rem;
        display: flex;
        align-items: center;
        gap: 8px;
      }

      .filter-option {
        display: flex;
        align-items: center;
        gap: 8px;
        margin-bottom: 8px;
        cursor: pointer;
      }

      .filter-option input[type="checkbox"] {
        width: 16px;
        height: 16px;
        cursor: pointer;
      }

      .filter-option label {
        cursor: pointer;
        color: #555;
        font-size: 0.9rem;
      }

      .price-range {
        display: flex;
        flex-direction: column;
        gap: 8px;
        align-items: center;
        margin-bottom: 10px;
      }

      .price-input {
        flex: 1;
        padding: 8px;
        border: 1px solid #ddd;
        border-radius: 6px;
        font-size: 0.9rem;
      }

      .btn-apply-price {
        width: 100%;
        padding: 8px;
        background: #2f8f44;
        color: white;
        border: none;
        border-radius: 6px;
        cursor: pointer;
        font-weight: 500;
        transition: background 0.3s;
      }

      .btn-apply-price:hover {
        background: #267a38;
      }

      .btn-clear-filters {
        width: 100%;
        padding: 10px;
        background: #f8f9fa;
        color: #333;
        border: 1px solid #ddd;
        border-radius: 6px;
        cursor: pointer;
        margin-top: 10px;
        font-weight: 500;
        display: flex;
        align-items: center;
        justify-content: center;
        gap: 8px;
        transition: all 0.3s;
      }

      .btn-clear-filters:hover {
        background: #e9ecef;
        border-color: #ccc;
      }

      select.filter-select {
        width: 100%;
        padding: 8px;
        border: 1px solid #ddd;
        border-radius: 6px;
        font-size: 0.9rem;
        background: white;
        cursor: pointer;
      }

      @media (max-width: 768px) {
        .top-bar {
          flex-direction: column;
          gap: 15px;
          padding: 15px;
        }

        .search-box-large {
          max-width: 100%;
          order: 2;
        }

        .top-actions {
          width: 100%;
          justify-content: space-between;
          order: 1;
        }

        .filter-row {
          flex-direction: column;
          gap: 15px;
          align-items: flex-start;
        }

        .filter-row-right {
          width: 100%;
          justify-content: space-between;
        }

        .products-grid {
          grid-template-columns: repeat(auto-fill, minmax(160px, 1fr));
          gap: 12px;
        }

        .product-image-container {
          height: 120px;
        }

        .filters-container {
          flex-direction: column;
        }

        .filters-sidebar {
          width: 100%;
          position: static;
        }
      }
    </style>
  </head>
  <body>
    <div class="app-container">
      <!-- Sidebar -->
      <aside class="sidebar buyer-sidebar">
        <div class="logo">
          <h2>üõí Our Local Market</h2>
          <p class="role">Shopping</p>
        </div>

        <nav class="nav-menu">
          <a href="buyer-dashboard.html" class="nav-item">
            <i class="fas fa-tachometer-alt"></i>
            <span>Dashboard</span>
          </a>
          <a href="index.html" class="nav-item active">
            <i class="fas fa-store"></i>
            <span>Shop Products</span>
          </a>
          <a href="cart.html" class="nav-item">
            <i class="fas fa-shopping-cart"></i>
            <span>My Cart</span>
            <span class="badge" id="cartCount">0</span>
          </a>
          <a
            href="#"
            class="nav-item"
            onclick="event.preventDefault(); showProfileModal();"
          >
            <i class="fas fa-user"></i>
            <span>My Account</span>
          </a>
          <a href="#" class="nav-item" id="logoutBtn">
            <i class="fas fa-sign-out-alt"></i>
            <span>Logout</span>
          </a>
        </nav>

        <div class="user-info">
          <div class="user-avatar">
            <img
              src="https://ui-avatars.com/api/?name=Buyer&background=2196F3&color=fff"
              alt="Buyer"
              id="userAvatar"
            />
          </div>
          <div class="user-details">
            <h4 id="buyerName">Loading...</h4>
            <p id="buyerEmail">...</p>
            <span class="status online">‚óè Shopping</span>
          </div>
        </div>
      </aside>

      <main class="main-content">
        <header class="top-bar buyer-header">
          <div class="search-box search-box-large">
            <i class="fas fa-search"></i>
            <input
              type="text"
              id="searchInput"
              placeholder="Search for products, farmers, categories..."
            />
          </div>
          <div class="top-actions">
            <div class="cart-badge" onclick="window.location.href='cart.html'">
              <i
                class="fas fa-shopping-cart"
                style="font-size: 1.3rem; cursor: pointer"
              ></i>
              <span class="cart-count" id="headerCartCount">0</span>
            </div>
            <div class="user-menu">
              <img
                src="https://ui-avatars.com/api/?name=Buyer&background=2196F3&color=fff"
                alt="User"
                id="headerAvatar"
              />
            </div>
          </div>
        </header>

        <div class="products-container">
          <div class="products-header">
            <h1>Shop Fresh Local Products</h1>
            <div class="filter-row">
              <div class="filter-row-left">
                <span id="productCount">0 products</span>
              </div>
              <div class="filter-row-right"></div>
            </div>
          </div>

          <div class="filters-container" id="filtersContainer">
            <div class="filters-sidebar">
              <div class="filter-group">
                <div class="filter-title">
                  <i class="fas fa-filter"></i> Categories
                </div>
                <div id="categoryFilters"></div>
              </div>

              <div class="filter-group">
                <div class="filter-title">
                  <i class="fas fa-tag"></i> Price Range
                </div>
                <div class="price-range">
                  <input
                    type="number"
                    id="minPrice"
                    placeholder="Min"
                    class="price-input"
                    min="0"
                  />
                  <span style="color: #666; font-size: 0.9rem">to</span>
                  <input
                    type="number"
                    id="maxPrice"
                    placeholder="Max"
                    class="price-input"
                    min="0"
                  />
                </div>
                <button onclick="applyPriceFilter()" class="btn-apply-price">
                  Apply Price Filter
                </button>
              </div>

              <div class="filter-group">
                <div class="filter-title">
                  <i class="fas fa-map-marker-alt"></i> Location
                </div>
                <select id="locationFilter" class="filter-select">
                  <option value="">All Locations</option>
                </select>
              </div>

              <div class="filter-group">
                <div class="filter-title">
                  <i class="fas fa-sort"></i> Sort By
                </div>
                <select id="sortFilter" class="filter-select">
                  <option value="newest">Newest First</option>
                  <option value="price_low">Price: Low to High</option>
                  <option value="price_high">Price: High to Low</option>
                  <option value="name">Name: A to Z</option>
                </select>
              </div>

              <button onclick="clearFilters()" class="btn-clear-filters">
                <i class="fas fa-redo"></i> Clear All Filters
              </button>
            </div>

            <div class="products-main">
              <div id="productsGrid" class="products-grid">
                <!-- Products will be loaded here -->
                <div class="loading-state">
                  <i class="fas fa-spinner fa-spin"></i>
                  <p>Loading products...</p>
                </div>
              </div>
            </div>
          </div>
        </div>
      </main>
    </div>

    <div id="productModalContainer"></div>
    <script>
      window.products = [
        {
          id: 2,
          name: "Potatoes",
          price: 15,
          unit: "kg",
          category: "vegetable",
          farmer: "Bekele Farm",
          location: "Sululta",
          image: "./pictures/potatoes.jpg",
        },
        {
          id: 3,
          name: "Cabbage",
          price: 13,
          unit: "kg",
          category: "vegetable",
          farmer: "Green Valley",
          location: "Burayu",
          image: "./pictures/cabbage.jpg",
        },
        {
          id: 4,
          name: "Tomatoes",
          price: 20,
          unit: "kg",
          category: "vegetable",
          farmer: "Red Farm",
          location: "Holeta",
          image: "./pictures/tomatoes.jpg",
        },
        {
          id: 5,
          name: "Bananas",
          price: 25,
          unit: "kg",
          category: "fruit",
          farmer: "Sunrise Farm",
          location: "Koye Feche",
          image: "./pictures/bananas.jpg",
        },
        {
          id: 6,
          name: "Coffee Beans",
          price: 150,
          unit: "kg",
          category: "grain",
          farmer: "Yirgacheffe Farm",
          location: "Bole Bulbula",
          image: "./pictures/coffee.jpg",
        },
        {
          id: 7,
          name: "Avocado",
          price: 35,
          unit: "kg",
          category: "fruit",
          farmer: "Green Gold Farm",
          location: "Alem Gena",
          image: "./pictures/Avocado.jpg",
        },
        {
          id: 8,
          name: "Onions",
          price: 18,
          unit: "kg",
          category: "vegetable",
          farmer: "Red Soil Farm",
          location: "Sendafa",
          image: "./pictures/onions.jpg",
        },
        {
          id: 9,
          name: "Mangoes",
          price: 40,
          unit: "kg",
          category: "fruit",
          farmer: "Tropical Delight",
          location: "Debre Zeit",
          image: "./pictures/mangoes.jpg",
        },
      ];
    </script>
    <script src="js/data.js"></script>
    <script src="js/shop.js"></script>
    <script>
      function checkAuth() {
        const token = localStorage.getItem("token");
        const user = JSON.parse(localStorage.getItem("user"));
        return token && user && user.role === "buyer";
      }

      document.addEventListener("DOMContentLoaded", function () {
        console.log("Page loaded, checking auth...");

        updateUserInfo();

        updateCartCount();

        if (typeof loadProducts === "function") {
          loadProducts();
        } else {
          console.error("loadProducts function not found! Check shop.js");
        }

        setupEventListeners();

        if (window.innerWidth <= 992) {
          document.getElementById("filtersContainer").style.display = "none";
        }
      });

      function updateUserInfo() {
        const user = JSON.parse(localStorage.getItem("user"));
        if (user) {
          document.getElementById("buyerName").textContent =
            user.fullName || "Buyer";
          document.getElementById("buyerEmail").textContent =
            user.email || "user@example.com";

          const avatars = document.querySelectorAll(
            "#userAvatar, #headerAvatar"
          );
          avatars.forEach((avatar) => {
            const name = user.fullName || "Buyer";
            avatar.src = `https://ui-avatars.com/api/?name=${encodeURIComponent(
              name
            )}&background=2196F3&color=fff`;
          });
        }
      }

      function updateCartCount() {
        const cart = JSON.parse(localStorage.getItem("cart")) || [];
        const totalItems = cart.reduce(
          (sum, item) => sum + (item.quantity || 1),
          0
        );
        document.getElementById("cartCount").textContent = totalItems;
        document.getElementById("headerCartCount").textContent = totalItems;
      }

      function setupEventListeners() {
        const searchInput = document.getElementById("searchInput");
        let searchTimeout;
        searchInput.addEventListener("input", function () {
          clearTimeout(searchTimeout);
          searchTimeout = setTimeout(() => {
            if (typeof loadProducts === "function") {
              loadProducts();
            }
          }, 500);
        });

        document
          .getElementById("sortFilter")
          .addEventListener("change", function () {
            if (typeof loadProducts === "function") {
              loadProducts();
            }
          });

        // Location filter
        document
          .getElementById("locationFilter")
          .addEventListener("change", function () {
            if (typeof loadProducts === "function") {
              loadProducts();
            }
          });

        document
          .getElementById("logoutBtn")
          .addEventListener("click", function (e) {
            e.preventDefault();
            if (confirm("Are you sure you want to logout?")) {
              localStorage.removeItem("token");
              localStorage.removeItem("user");
              localStorage.removeItem("cart");
              window.location.href = "login.html";
            }
          });
      }

      function applyPriceFilter() {
        if (typeof loadProducts === "function") {
          loadProducts();
        }
      }

      function clearFilters() {
        document.getElementById("searchInput").value = "";
        document.getElementById("minPrice").value = "";
        document.getElementById("maxPrice").value = "";
        document.getElementById("locationFilter").value = "";
        document.getElementById("sortFilter").value = "newest";

        document
          .querySelectorAll('#categoryFilters input[type="checkbox"]')
          .forEach((checkbox) => {
            checkbox.checked = false;
          });

        if (typeof loadProducts === "function") {
          loadProducts();
        }
      }

      function toggleFilters() {
        const filters = document.getElementById("filtersContainer");
        if (filters.style.display === "none" || filters.style.display === "") {
          filters.style.display = "flex";
        } else {
          filters.style.display = "none";
        }
      }

      async function showProfileModal() {
        const modal = document.createElement("div");
        modal.id = "profileModal";
        modal.style.cssText =
          "position: fixed; top: 0; left: 0; right: 0; bottom: 0; background: rgba(0,0,0,0.5); display: flex; align-items: center; justify-content: center; z-index: 10000;";

        try {
          const token = localStorage.getItem("token");
          const response = await fetch(
            "http://localhost:5000/api/auth/profile",
            {
              headers: {
                Authorization: `Bearer ${token}`,
                "Content-Type": "application/json",
              },
            }
          );

          const data = await response.json();
          const user = data.user || JSON.parse(localStorage.getItem("user"));

          modal.innerHTML = `
            <div style="background: white; border-radius: 12px; width: 90%; max-width: 600px; max-height: 90vh; overflow-y: auto;">
              <div style="padding: 1.5rem; border-bottom: 1px solid #eee; display: flex; justify-content: space-between; align-items: center;">
                <h3 style="margin: 0;">My Profile</h3>
                <button onclick="closeProfileModal()" style="background: none; border: none; font-size: 1.5rem; cursor: pointer; color: #666;">&times;</button>
              </div>
              <form id="profileForm" style="padding: 1.5rem;">
                <div style="margin-bottom: 1rem;">
                  <label style="display: block; margin-bottom: 0.5rem; font-weight: 500;">Full Name *</label>
                  <input type="text" id="fullName" name="fullName" value="${
                    user.fullName || ""
                  }" required 
                         style="width: 100%; padding: 0.75rem; border: 1px solid #ddd; border-radius: 6px;">
                </div>
                <div style="margin-bottom: 1rem;">
                  <label style="display: block; margin-bottom: 0.5rem; font-weight: 500;">Email</label>
                  <input type="email" id="email" value="${
                    user.email || ""
                  }" disabled 
                         style="width: 100%; padding: 0.75rem; border: 1px solid #ddd; border-radius: 6px; background: #f5f5f5; cursor: not-allowed;">
                  <small style="color: #666;">Email cannot be changed</small>
                </div>
                <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 1rem; margin-bottom: 1rem;">
                  <div>
                    <label style="display: block; margin-bottom: 0.5rem; font-weight: 500;">Phone Number *</label>
                    <input type="tel" id="phone" name="phone" value="${
                      user.phone || ""
                    }" required 
                           style="width: 100%; padding: 0.75rem; border: 1px solid #ddd; border-radius: 6px;">
                  </div>
                  <div>
                    <label style="display: block; margin-bottom: 0.5rem; font-weight: 500;">City *</label>
                    <input type="text" id="city" name="city" value="${
                      user.city || ""
                    }" required 
                           style="width: 100%; padding: 0.75rem; border: 1px solid #ddd; border-radius: 6px;">
                  </div>
                </div>
                <div style="margin-bottom: 1rem;">
                  <label style="display: block; margin-bottom: 0.5rem; font-weight: 500;">Address</label>
                  <textarea id="address" name="address" rows="2" 
                            style="width: 100%; padding: 0.75rem; border: 1px solid #ddd; border-radius: 6px;">${
                              user.address || ""
                            }</textarea>
                </div>
                <div style="display: flex; gap: 1rem; margin-top: 1.5rem;">
                  <button type="button" onclick="closeProfileModal()" 
                          style="flex: 1; padding: 0.75rem; border: 1px solid #ddd; border-radius: 6px; background: #f8f9fa; cursor: pointer;">
                    Cancel
                  </button>
                  <button type="submit" 
                          style="flex: 1; padding: 0.75rem; border: none; border-radius: 6px; background: #2f8f44; color: white; font-weight: 600; cursor: pointer;">
                    Save Changes
                  </button>
                </div>
              </form>
            </div>
          `;

          document.body.appendChild(modal);

          document
            .getElementById("profileForm")
            .addEventListener("submit", async (e) => {
              e.preventDefault();
              await handleProfileSubmit();
            });

          modal.addEventListener("click", (e) => {
            if (e.target === modal) closeProfileModal();
          });
        } catch (error) {
          console.error("Error loading profile:", error);
          modal.innerHTML = `
            <div style="background: white; border-radius: 12px; padding: 2rem; text-align: center;">
              <p style="color: #f44336;">Failed to load profile</p>
              <button onclick="closeProfileModal()" style="margin-top: 1rem; padding: 0.5rem 1rem; background: #2f8f44; color: white; border: none; border-radius: 6px; cursor: pointer;">
                Close
              </button>
            </div>
          `;
          document.body.appendChild(modal);
        }
      }

      async function handleProfileSubmit() {
        const formData = {
          fullName: document.getElementById("fullName").value.trim(),
          phone: document.getElementById("phone").value.trim(),
          city: document.getElementById("city").value.trim(),
          address: document.getElementById("address").value.trim(),
        };

        if (!formData.fullName || !formData.phone || !formData.city) {
          alert("Please fill all required fields (*)");
          return;
        }

        try {
          const token = localStorage.getItem("token");
          const response = await fetch(
            "http://localhost:5000/api/auth/profile",
            {
              method: "PUT",
              headers: {
                Authorization: `Bearer ${token}`,
                "Content-Type": "application/json",
              },
              body: JSON.stringify(formData),
            }
          );

          const data = await response.json();

          if (response.ok && data.success) {
            localStorage.setItem("user", JSON.stringify(data.user));
            updateUserInfo();
            closeProfileModal();
            alert("Profile updated successfully! üéâ");
          } else {
            alert(data.message || "Failed to update profile");
          }
        } catch (error) {
          console.error("Error updating profile:", error);
          alert("Failed to update profile. Please try again.");
        }
      }

      function closeProfileModal() {
        const modal = document.getElementById("profileModal");
        if (modal) modal.remove();
      }

      window.applyPriceFilter = applyPriceFilter;
      window.clearFilters = clearFilters;
      window.showProfileModal = showProfileModal;
      window.closeProfileModal = closeProfileModal;
      window.toggleFilters = toggleFilters;
    </script>
  </body>
</html>
